#!/bin/bash
# =============================================================================
# ESPHome LD2450 - Radar USB Connection Script for WSL
# =============================================================================
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç —Ä–∞–¥–∞—Ä –∫ WSL —á–µ—Ä–µ–∑ usbipd
# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç UART to USB –ø–µ—Ä–µ—Ö–æ–¥–Ω–∏–∫–∏ (CH340, CP2102, FT232)
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/connect_radar.sh [BUSID]
# –ü—Ä–∏–º–µ—Ä: ./scripts/connect_radar.sh 5-6
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
# - Windows —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º usbipd-win
# - WSL2
# - –†–∞–¥–∞—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ USB –ø–æ—Ä—Ç—É Windows
# =============================================================================

# BUSID –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç)
BUSID=${1:-"5-6"}

echo -e "\033[32müì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–¥–∞—Ä–∞ –≤ WSL...\033[0m"

# –í—ã–ø–æ–ª–Ω—è–µ–º usbipd –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ PowerShell
powershell.exe -Command "
    Write-Host 'üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ø–∏—Å–æ–∫ USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤...' -ForegroundColor Cyan
    usbipd list

    Write-Host \"üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–∞–¥–∞—Ä (BUSID ${BUSID})...\" -ForegroundColor Yellow

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    \$status = usbipd list | Select-String '${BUSID}' | Select-String 'Shared'
    if (\$status) {
        Write-Host '‚úÖ –†–∞–¥–∞—Ä —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω' -ForegroundColor Green
    } else {
        Write-Host 'üîó –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Ä–∞–¥–∞—Ä...' -ForegroundColor Yellow
        usbipd bind --busid ${BUSID}
    }

    Write-Host 'üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ä–∞–¥–∞—Ä –∫ WSL...' -ForegroundColor Yellow
    usbipd attach --wsl --busid ${BUSID}

    Write-Host '‚úÖ –†–∞–¥–∞—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ WSL!' -ForegroundColor Green
"

echo ""
echo -e "\033[33m‚è≥ –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –≤ PowerShell...\033[0m"
sleep 10

echo -e "\033[35müîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å usbipd –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞...\033[0m"
echo -e "\033[36müìã –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å USB —É—Å—Ç—Ä–æ–π—Å—Ç–≤:\033[0m"
powershell.exe usbipd list

echo ""
echo -e "\033[35müîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–∞...\033[0m"
if [ -e /dev/ttyUSB0 ]; then
    echo -e "\033[32m‚úÖ –ü–æ—Ä—Ç /dev/ttyUSB0 –¥–æ—Å—Ç—É–ø–µ–Ω!\033[0m"
    echo ""
    echo -e "\033[36müöÄ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–¥–∞—Ä–æ–º:\033[0m"
    echo -e "\033[37m  # –ú–æ–Ω–∏—Ç–æ—Ä —Ä–∞–¥–∞—Ä–∞ (Python - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):\033[0m"
    echo -e "\033[37m  python3 scripts/radar.py\033[0m"
    echo ""
    echo -e "\033[37m  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ—Ä—Ç—ã:\033[0m"
    echo -e "\033[37m  ls -la /dev/ttyUSB*\033[0m"
elif [ -e /dev/ttyUSB1 ]; then
    echo -e "\033[32m‚úÖ –ü–æ—Ä—Ç /dev/ttyUSB1 –¥–æ—Å—Ç—É–ø–µ–Ω!\033[0m"
    echo ""
    echo -e "\033[36müöÄ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–¥–∞—Ä–æ–º:\033[0m"
    echo -e "\033[37m  # –ú–æ–Ω–∏—Ç–æ—Ä —Ä–∞–¥–∞—Ä–∞ (Python - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):\033[0m"
    echo -e "\033[37m  python3 scripts/radar.py\033[0m"
    echo ""
    echo -e "\033[37m  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ—Ä—Ç—ã:\033[0m"
    echo -e "\033[37m  ls -la /dev/ttyUSB*\033[0m"
else
    echo -e "\033[31m‚ùå –ü–æ—Ä—Ç—ã /dev/ttyUSB0 –∏ /dev/ttyUSB1 –Ω–µ –Ω–∞–π–¥–µ–Ω—ã\033[0m"
    echo -e "\033[33müîß –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:\033[0m"
    echo -e "\033[37m  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ USB –ø–æ—Ä—Ç—ã: ls -la /dev/ttyUSB*\033[0m"
    echo -e "\033[37m  2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å usbipd —Å—Ç–∞—Ç—É—Å: usbipd list (–≤ PowerShell)\033[0m"
    echo -e "\033[37m  3. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å USB –∫–∞–±–µ–ª—å —Ä–∞–¥–∞—Ä–∞\033[0m"
    echo -e "\033[37m  4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∏—Ç–∞–Ω–∏–µ —Ä–∞–¥–∞—Ä–∞\033[0m"
    echo -e "\033[37m  5. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π USB –ø–æ—Ä—Ç –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ\033[0m"
    echo -e "\033[37m  6. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ usbipd\033[0m"
    echo ""
    echo -e "\033[36müîß –†—É—á–Ω–æ–π —Å–ø–æ—Å–æ–± –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:\033[0m"
    echo -e "\033[37m  1. –û—Ç–∫—Ä–æ–π—Ç–µ PowerShell –æ—Ç –∏–º–µ–Ω–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\033[0m"
    echo -e "\033[37m  2. –ù–∞–π–¥–∏—Ç–µ BUSID –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: usbipd list\033[0m"
    echo -e "\033[37m  3. –ü—Ä–∏–≤—è–∂–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: usbipd bind --busid <BUSID>\033[0m"
    echo -e "\033[37m  4. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫ WSL: usbipd attach --wsl --busid <BUSID>\033[0m"
    echo ""
    echo -e "\033[37m  –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º:\033[0m"
    echo -e "\033[37m  ./scripts/connect_radar.sh <BUSID>\033[0m"
fi
