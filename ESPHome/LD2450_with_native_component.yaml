#Make on https://53l3cu5.github.io/
#Origin https://github.com/53l3cu5/ESP32_LD2450
#
# ============================================================================
# –ú–ò–ù–ò–ú–ê–õ–ò–°–¢–ò–ß–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø: –ù–∞—Ç–∏–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç + –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –∑–æ–Ω—ã
# ============================================================================
# –í–ö–õ–Æ–ß–ê–ï–¢:
#  ‚úÖ –ù–∞—Ç–∏–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ESPHome –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–¥–∞—Ä–æ–º
#  ‚úÖ 3 –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –∑–æ–Ω—ã —Ä–∞–¥–∞—Ä–∞ (–Ω–∞ —É—Ä–æ–≤–Ω–µ LD2450)
#  ‚úÖ –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–¥–∞—Ä–∞, factory reset
#  ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Multi-Target, Bluetooth
#  ‚úÖ LED-–∏–Ω–¥–∏–∫–∞—Ü–∏—è —Å –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–µ–π (–±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
# 
# –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –∑–æ–Ω—ã —Ä–∞–¥–∞—Ä–∞ (–∫–∞—Å–∫–∞–¥–Ω—ã–µ –ø–æ –≥–ª—É–±–∏–Ω–µ):
#   –ó–æ–Ω–∞ 1: —à–∏—Ä–∏–Ω–∞ 2–º (–æ—Ç -1–º –¥–æ +1–º), –≥–ª—É–±–∏–Ω–∞ –æ—Ç 0.25–º –¥–æ 1.0–º
#   –ó–æ–Ω–∞ 2: —à–∏—Ä–∏–Ω–∞ 4–º (–æ—Ç -2–º –¥–æ +2–º), –≥–ª—É–±–∏–Ω–∞ –æ—Ç 1.0–º –¥–æ 3.0–º
#   –ó–æ–Ω–∞ 3: —à–∏—Ä–∏–Ω–∞ 6–º (–æ—Ç -3–º –¥–æ +3–º), –≥–ª—É–±–∏–Ω–∞ –æ—Ç 3.0–º –¥–æ 6.0–º
# 
# –†–∞–¥–∞—Ä –ø–µ—Ä–µ–¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ —Ü–µ–ª–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∑–æ–Ω!
# ============================================================================

substitutions:
  devicename: ld2450
  friendly_name: LD2450
  entity_name: "Radar"
  tx_pin_ld2450: GPIO17
  rx_pin_ld2450: GPIO16
  blue_led_pin: GPIO2

esphome:
  name: $devicename
  friendly_name: ${friendly_name}
  comment: Human Presence Sensor by Zone (ESP32/LD2450) with Native Component
  platformio_options:
    board_build.flash_mode: dio
  project:
    name: 53l3cu5.Human_Presence_Sensor_by_Zone
    version: "3.0-minimal-espidf"

  on_boot:
    priority: -100
    then:
      - logger.log: "‚úÖ ESP32 boot complete"
      - delay: 5s
      - if:
          condition:
            lambda: 'return id(first_boot);'
          then:
            - logger.log: "üÜï –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - –ø—Ä–∏–º–µ–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–æ–Ω—ã"
            - button.press: btn_apply_defaults
            - delay: 2s
            - logger.log: "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–¥–∞—Ä –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫"
            - button.press: radar_radar_restart
            - delay: 3s
            - globals.set:
                id: first_boot
                value: 'false'
            - logger.log: "‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

preferences:
  flash_write_interval: 5s

# ============================================================================
# GLOBALS
# ============================================================================
globals:
  - id: first_boot
    type: bool
    restore_value: yes
    initial_value: 'true'
  
  - id: sensor_throttle
    type: int
    restore_value: yes
    initial_value: '100'
  
  - id: radar_sensitivity
    type: int
    restore_value: yes
    initial_value: '5'
  
  - id: energy_threshold
    type: int
    restore_value: yes
    initial_value: '1000'
  
  - id: target_hold_time
    type: int
    restore_value: yes
    initial_value: '5'
  
  - id: speed_filter
    type: int
    restore_value: yes
    initial_value: '5'
  
  - id: working_mode
    type: int
    restore_value: yes
    initial_value: '0'
  
  - id: update_rate
    type: int
    restore_value: yes
    initial_value: '10'

esp32:
  board: esp32dev
  framework:
    type: esp-idf

improv_serial:
logger:

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password
  - platform: web_server

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: NONE
  reboot_timeout: 15min
  ap:
    ssid: "${devicename} Hotspot"
    password: !secret hotspot_password
    channel: 1
    manual_ip:
      static_ip: 192.168.4.1
      gateway: 192.168.4.1
      subnet: 255.255.255.0

captive_portal:

web_server:
  port: 80
  include_internal: false
  local: true

# ============================================================================
# UART –∏ —Ä–∞–¥–∞—Ä
# ============================================================================
uart:
  id: uart_bus
  tx_pin: ${tx_pin_ld2450}
  rx_pin: ${rx_pin_ld2450}
  baud_rate: 256000
  parity: NONE
  stop_bits: 1
  data_bits: 8

ld2450:
  id: ld2450_radar
  uart_id: uart_bus

# ============================================================================
# –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–ò
# ============================================================================
switch:
  - platform: ld2450
    multi_target:
      name: "–†–µ–∂–∏–º –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ü–µ–ª–µ–π"
      id: multi_target_mode
      icon: mdi:target-account
      entity_category: config
      restore_mode: RESTORE_DEFAULT_ON
      on_turn_on:
        then:
          - lambda: |-
              if (id(update_rate_setting).state > 10) {
                id(update_rate_setting).make_call().set_value(10).perform();
                ESP_LOGW("multi_target", "‚ö†Ô∏è –ß–∞—Å—Ç–æ—Ç–∞ —Å–Ω–∏–∂–µ–Ω–∞ –¥–æ 10 –ì—Ü");
              }
              if (id(sensor_throttle_setting).state < 100) {
                id(sensor_throttle_setting).make_call().set_value(100).perform();
                ESP_LOGW("multi_target", "‚ö†Ô∏è Throttle —É–≤–µ–ª–∏—á–µ–Ω –¥–æ 100 –º—Å");
              }
      on_turn_off:
        then:
          - logger.log: "‚úÖ Single-Target: —Ä–∞–∑—Ä–µ—à–µ–Ω–æ –¥–æ 20 –ì—Ü / 50 –º—Å"
  
  - platform: ld2450
    bluetooth:
      name: "Bluetooth"
      id: bluetooth_mode
      icon: mdi:bluetooth
      entity_category: config
      disabled_by_default: true

  - platform: template
    name: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è LED"
    id: led_auto_switch
    entity_category: config
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    on_turn_on:
      then:
        - logger.log: "üí° LED –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: –í–ö–õ"
    on_turn_off:
      then:
        - light.turn_off: blue_radar_led
        - logger.log: "üåô LED –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: –í–´–ö–õ (—Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º)"

# ============================================================================
# BINARY SENSORS
# ============================================================================
binary_sensor:
  - platform: status
    name: "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ HA"
    id: ink_ha_connected
  
  - platform: ld2450
    has_target:
      name: "–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ —Ü–µ–ª–∏"
      id: radar_has_target
  
  - platform: template
    name: "–ó–æ–Ω–∞ 1 - –ë–ª–∏–∑–∫–æ"
    id: zone1_presence
    lambda: |-
      float x1 = id(target1_x).state, y1 = id(target1_y).state;
      float x2 = id(target2_x).state, y2 = id(target2_y).state;
      float x3 = id(target3_x).state, y3 = id(target3_y).state;
      bool in_zone = false;
      if (!isnan(x1) && x1 >= -1000 && x1 <= 1000 && !isnan(y1) && y1 >= 250 && y1 < 1000) in_zone = true;
      if (!isnan(x2) && x2 >= -1000 && x2 <= 1000 && !isnan(y2) && y2 >= 250 && y2 < 1000) in_zone = true;
      if (!isnan(x3) && x3 >= -1000 && x3 <= 1000 && !isnan(y3) && y3 >= 250 && y3 < 1000) in_zone = true;
      return in_zone;
    device_class: occupancy
  
  - platform: template
    name: "–ó–æ–Ω–∞ 2 - –°—Ä–µ–¥–Ω–µ"
    id: zone2_presence
    lambda: |-
      float x1 = id(target1_x).state, y1 = id(target1_y).state;
      float x2 = id(target2_x).state, y2 = id(target2_y).state;
      float x3 = id(target3_x).state, y3 = id(target3_y).state;
      bool in_zone = false;
      if (!isnan(x1) && x1 >= -2000 && x1 <= 2000 && !isnan(y1) && y1 >= 1000 && y1 < 3000) in_zone = true;
      if (!isnan(x2) && x2 >= -2000 && x2 <= 2000 && !isnan(y2) && y2 >= 1000 && y2 < 3000) in_zone = true;
      if (!isnan(x3) && x3 >= -2000 && x3 <= 2000 && !isnan(y3) && y3 >= 1000 && y3 < 3000) in_zone = true;
      return in_zone;
    device_class: occupancy
  
  - platform: template
    name: "–ó–æ–Ω–∞ 3 - –î–∞–ª–µ–∫–æ"
    id: zone3_presence
    lambda: |-
      float x1 = id(target1_x).state, y1 = id(target1_y).state;
      float x2 = id(target2_x).state, y2 = id(target2_y).state;
      float x3 = id(target3_x).state, y3 = id(target3_y).state;
      bool in_zone = false;
      if (!isnan(x1) && x1 >= -3000 && x1 <= 3000 && !isnan(y1) && y1 >= 3000 && y1 <= 6000) in_zone = true;
      if (!isnan(x2) && x2 >= -3000 && x2 <= 3000 && !isnan(y2) && y2 >= 3000 && y2 <= 6000) in_zone = true;
      if (!isnan(x3) && x3 >= -3000 && x3 <= 3000 && !isnan(y3) && y3 >= 3000 && y3 <= 6000) in_zone = true;
      return in_zone;
    device_class: occupancy

# ============================================================================
# SENSORS
# ============================================================================
sensor:
  - platform: uptime
    name: "–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã"
    update_interval: 60s
    disabled_by_default: True
  
  - platform: wifi_signal
    name: "–°–∏–ª–∞ —Å–∏–≥–Ω–∞–ª–∞ WiFi"
    update_interval: 60s
    entity_category: "diagnostic"

  - platform: ld2450
    target_count:
      name: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ü–µ–ª–µ–π"
    
  - platform: ld2450
    target_1:
      x:
        name: "–¶–µ–ª—å 1 - X"
        id: target1_x
        filters:
          - throttle: 100ms
      y:
        name: "–¶–µ–ª—å 1 - Y"
        id: target1_y
        filters:
          - throttle: 100ms
      speed:
        name: "–¶–µ–ª—å 1 - –°–∫–æ—Ä–æ—Å—Ç—å"
        id: target1_speed
        filters:
          - throttle: 100ms
      angle:
        name: "–¶–µ–ª—å 1 - –£–≥–æ–ª"
        id: target1_angle
        filters:
          - throttle: 100ms
      resolution:
        name: "–¶–µ–ª—å 1 - –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ"
        id: target1_resolution
        filters:
          - throttle: 100ms

  - platform: ld2450
    target_2:
      x:
        name: "–¶–µ–ª—å 2 - X"
        id: target2_x
        filters:
          - throttle: 100ms
      y:
        name: "–¶–µ–ª—å 2 - Y"
        id: target2_y
        filters:
          - throttle: 100ms
      speed:
        name: "–¶–µ–ª—å 2 - –°–∫–æ—Ä–æ—Å—Ç—å"
        id: target2_speed
        filters:
          - throttle: 100ms
      angle:
        name: "–¶–µ–ª—å 2 - –£–≥–æ–ª"
        id: target2_angle
        filters:
          - throttle: 100ms
      resolution:
        name: "–¶–µ–ª—å 2 - –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ"
        id: target2_resolution
        filters:
          - throttle: 100ms

  - platform: ld2450
    target_3:
      x:
        name: "–¶–µ–ª—å 3 - X"
        id: target3_x
        filters:
          - throttle: 100ms
      y:
        name: "–¶–µ–ª—å 3 - Y"
        id: target3_y
        filters:
          - throttle: 100ms
      speed:
        name: "–¶–µ–ª—å 3 - –°–∫–æ—Ä–æ—Å—Ç—å"
        id: target3_speed
        filters:
          - throttle: 100ms
      angle:
        name: "–¶–µ–ª—å 3 - –£–≥–æ–ª"
        id: target3_angle
        filters:
          - throttle: 100ms
      resolution:
        name: "–¶–µ–ª—å 3 - –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ"
        id: target3_resolution
        filters:
          - throttle: 100ms

# ============================================================================
# –ê–ü–ü–ê–†–ê–¢–ù–´–ï –ó–û–ù–´
# ============================================================================
number:
  - platform: ld2450
    zone_1:
      x1:
        name: "–ó–æ–Ω–∞ 1 - X1"
        id: hw_zone1_x1
        unit_of_measurement: mm
      y1:
        name: "–ó–æ–Ω–∞ 1 - Y1"
        id: hw_zone1_y1
        unit_of_measurement: mm
      x2:
        name: "–ó–æ–Ω–∞ 1 - X2"
        id: hw_zone1_x2
        unit_of_measurement: mm
      y2:
        name: "–ó–æ–Ω–∞ 1 - Y2"
        id: hw_zone1_y2
        unit_of_measurement: mm
    presence_timeout:
      name: "–ó–æ–Ω–∞ 1 - –¢–∞–π–º–∞—É—Ç"
      id: hw_zone1_timeout
  
  - platform: ld2450
    zone_2:
      x1:
        name: "–ó–æ–Ω–∞ 2 - X1"
        id: hw_zone2_x1
        unit_of_measurement: mm
      y1:
        name: "–ó–æ–Ω–∞ 2 - Y1"
        id: hw_zone2_y1
        unit_of_measurement: mm
      x2:
        name: "–ó–æ–Ω–∞ 2 - X2"
        id: hw_zone2_x2
        unit_of_measurement: mm
      y2:
        name: "–ó–æ–Ω–∞ 2 - Y2"
        id: hw_zone2_y2
        unit_of_measurement: mm
    presence_timeout:
      name: "–ó–æ–Ω–∞ 2 - –¢–∞–π–º–∞—É—Ç"
      id: hw_zone2_timeout
  
  - platform: ld2450
    zone_3:
      x1:
        name: "–ó–æ–Ω–∞ 3 - X1"
        id: hw_zone3_x1
        unit_of_measurement: mm
      y1:
        name: "–ó–æ–Ω–∞ 3 - Y1"
        id: hw_zone3_y1
        unit_of_measurement: mm
      x2:
        name: "–ó–æ–Ω–∞ 3 - X2"
        id: hw_zone3_x2
        unit_of_measurement: mm
      y2:
        name: "–ó–æ–Ω–∞ 3 - Y2"
        id: hw_zone3_y2
        unit_of_measurement: mm
    presence_timeout:
      name: "–ó–æ–Ω–∞ 3 - –¢–∞–π–º–∞—É—Ç"
      id: hw_zone3_timeout

# ============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ò
# ============================================================================
  - platform: template
    name: "–ó–∞–¥–µ—Ä–∂–∫–∞ —Å–µ–Ω—Å–æ—Ä–æ–≤"
    id: sensor_throttle_setting
    min_value: 50
    max_value: 1000
    step: 10
    unit_of_measurement: "ms"
    mode: box
    optimistic: true
    initial_value: 100
    restore_value: true
    entity_category: config
    icon: mdi:speedometer
    on_value:
      then:
        - lambda: |-
            if (id(multi_target_mode).state && x < 100) {
              id(sensor_throttle_setting).make_call().set_value(100).perform();
              ESP_LOGW("throttle", "‚ö†Ô∏è Multi-Target —Ç—Ä–µ–±—É–µ—Ç –º–∏–Ω–∏–º—É–º 100 –º—Å");
            } else {
              id(sensor_throttle) = x;
              ESP_LOGI("throttle", "‚öôÔ∏è Throttle: %d –º—Å", (int)x);
            }

  - platform: template
    name: "–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–¥–∞—Ä–∞"
    id: radar_sensitivity_setting
    min_value: 0
    max_value: 9
    step: 1
    mode: slider
    optimistic: true
    initial_value: 5
    restore_value: true
    entity_category: config
    icon: mdi:signal-variant
    on_value:
      then:
        - lambda: 'id(radar_sensitivity) = x;'
        - logger.log:
            format: "üéöÔ∏è –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: %d (–Ω–∞–∂–º–∏—Ç–µ Write Config)"
            args: ['(int)x']
  
  - platform: template
    name: "–ü–æ—Ä–æ–≥ —ç–Ω–µ—Ä–≥–∏–∏"
    id: energy_threshold_setting
    min_value: 100
    max_value: 10000
    step: 100
    mode: box
    optimistic: true
    initial_value: 1000
    restore_value: true
    entity_category: config
    icon: mdi:flash
    on_value:
      then:
        - lambda: 'id(energy_threshold) = x;'
        - logger.log:
            format: "‚ö° –ü–æ—Ä–æ–≥ —ç–Ω–µ—Ä–≥–∏–∏: %d"
            args: ['(int)x']
  
  - platform: template
    name: "–í—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è —Ü–µ–ª–∏"
    id: target_hold_time_setting
    min_value: 0
    max_value: 60
    step: 1
    unit_of_measurement: "s"
    mode: box
    optimistic: true
    initial_value: 5
    restore_value: true
    entity_category: config
    icon: mdi:timer-sand
    on_value:
      then:
        - lambda: 'id(target_hold_time) = x;'
        - logger.log:
            format: "‚è±Ô∏è Timeout —É–¥–µ—Ä–∂–∞–Ω–∏—è: %d —Å–µ–∫"
            args: ['(int)x']
  
  - platform: template
    name: "–§–∏–ª—å—Ç—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏"
    id: speed_filter_setting
    min_value: 0
    max_value: 100
    step: 1
    unit_of_measurement: "cm/s"
    mode: box
    optimistic: true
    initial_value: 5
    restore_value: true
    entity_category: config
    icon: mdi:speedometer-slow
    on_value:
      then:
        - lambda: 'id(speed_filter) = x;'
        - logger.log:
            format: "üèÉ –§–∏–ª—å—Ç—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏: %d —Å–º/—Å"
            args: ['(int)x']
  
  - platform: template
    name: "–ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
    id: update_rate_setting
    min_value: 1
    max_value: 20
    step: 1
    unit_of_measurement: "Hz"
    mode: box
    optimistic: true
    initial_value: 10
    restore_value: true
    entity_category: config
    icon: mdi:update
    on_value:
      then:
        - lambda: |-
            if (id(multi_target_mode).state && x > 10) {
              id(update_rate_setting).make_call().set_value(10).perform();
              ESP_LOGW("update_rate", "‚ö†Ô∏è Multi-Target –º–∞–∫—Å–∏–º—É–º 10 –ì—Ü");
            } else {
              id(update_rate) = x;
              ESP_LOGI("update_rate", "üì° –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: %d –ì—Ü", (int)x);
            }

select:
  - platform: template
    name: "–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã"
    id: working_mode_select
    optimistic: true
    options:
      - "Normal"
      - "High Sensitivity"
      - "Low Power"
      - "High Precision"
    initial_option: "Normal"
    restore_value: true
    entity_category: config
    icon: mdi:tune-variant
    on_value:
      then:
        - lambda: |-
            int mode = 0;
            if (x == "Normal") mode = 0;
            else if (x == "High Sensitivity") mode = 1;
            else if (x == "Low Power") mode = 2;
            else if (x == "High Precision") mode = 3;
            id(working_mode) = mode;
            ESP_LOGI("LD2450", "üéõÔ∏è –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: %s (%d)", x.c_str(), mode);

text_sensor:
  - platform: template
    name: "–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
    id: config_status
    icon: mdi:information
    entity_category: diagnostic
    update_interval: 10s
    lambda: |-
      char status[200];
      const char* mode_names[] = {"Normal", "High Sens", "Low Pwr", "Hi Prec"};
      sprintf(status, "Throttle:%dms Sens:%d Energy:%d Hold:%ds Speed:%dcm/s Rate:%dHz Mode:%s LED:%s", 
              id(sensor_throttle), 
              id(radar_sensitivity),
              id(energy_threshold),
              id(target_hold_time),
              id(speed_filter),
              id(update_rate),
              mode_names[id(working_mode)],
              id(led_auto_switch).state ? "Auto" : "Manual");
      return {status};

# ============================================================================
# –ò–ù–î–ò–ö–ê–¶–ò–Ø
# ============================================================================
light:
  - platform: status_led
    name: "–°–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ç—É—Å"
    pin: GPIO13
    internal: True
    restore_mode: ALWAYS_OFF
  
  - platform: monochromatic
    name: "LED –∏–Ω–¥–∏–∫–∞—Ü–∏—è"
    id: blue_radar_led
    output: blue_led_output
    entity_category: config
    restore_mode: RESTORE_DEFAULT_OFF
    effects:
      - strobe:
          name: "Slow Blink"
          colors:
            - state: true
              duration: 500ms
            - state: false
              duration: 500ms
      - strobe:
          name: "Fast Blink"
          colors:
            - state: true
              duration: 166ms
            - state: false
              duration: 166ms

output:
  - platform: ledc
    id: blue_led_output
    pin:
      number: ${blue_led_pin}
      inverted: true
    frequency: 1000Hz

# ============================================================================
# –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–Ø
# ============================================================================
interval:
  - interval: 5s
    then:
      - if:
          condition:
            lambda: 'return !id(multi_target_mode).state;'
          then:
            - switch.turn_on: multi_target_mode
            - logger.log: "‚úÖ –†–µ–∂–∏–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π –≤–∫–ª—é—á–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
  
  - interval: 300ms
    then:
      - if:
          condition:
            switch.is_on: led_auto_switch
          then:
            - lambda: |-
                if (id(zone1_presence).state) {
                  auto call = id(blue_radar_led).turn_on();
                  call.set_effect("None");
                  call.perform();
                } else if (id(zone2_presence).state) {
                  auto call = id(blue_radar_led).turn_on();
                  call.set_effect("Slow Blink");
                  call.perform();
                } else if (id(zone3_presence).state) {
                  auto call = id(blue_radar_led).turn_on();
                  call.set_effect("Fast Blink");
                  call.perform();
                } else {
                  id(blue_radar_led).turn_off().perform();
                }

# ============================================================================
# –ö–ù–û–ü–ö–ò
# ============================================================================
button:
  - platform: restart
    icon: mdi:power-cycle
    name: "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ ESP"
    entity_category: diagnostic
  
  - platform: ld2450
    restart:
      name: "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–¥–∞—Ä–∞"
      id: radar_radar_restart
      icon: mdi:restart
      entity_category: config
  
  - platform: ld2450
    factory_reset:
      name: "–°–±—Ä–æ—Å –∫ –∑–∞–≤–æ–¥—Å–∫–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º"
      id: radar_factory_reset
      icon: mdi:restart-alert
      entity_category: config
  
  - platform: template
    name: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∑–æ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
    id: btn_apply_defaults
    icon: mdi:restore
    entity_category: config
    on_press:
      then:
        - logger.log: "üìê –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞—Å–∫–∞–¥–Ω—ã–µ –∑–æ–Ω—ã –ø–æ –≥–ª—É–±–∏–Ω–µ..."
        - number.set:
            id: hw_zone1_x1
            value: -1000
        - number.set:
            id: hw_zone1_y1
            value: 250
        - number.set:
            id: hw_zone1_x2
            value: 1000
        - number.set:
            id: hw_zone1_y2
            value: 1000
        - number.set:
            id: hw_zone2_x1
            value: -2000
        - number.set:
            id: hw_zone2_y1
            value: 1000
        - number.set:
            id: hw_zone2_x2
            value: 2000
        - number.set:
            id: hw_zone2_y2
            value: 3000
        - number.set:
            id: hw_zone3_x1
            value: -3000
        - number.set:
            id: hw_zone3_y1
            value: 3000
        - number.set:
            id: hw_zone3_x2
            value: 3000
        - number.set:
            id: hw_zone3_y2
            value: 6000
        - logger.log: "‚úÖ –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–æ–Ω—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã (–Ω–∞–∂–º–∏—Ç–µ Restart Radar)"
  
  - platform: template
    name: "–ó–∞–ø–∏—Å–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ —Ä–∞–¥–∞—Ä"
    id: btn_write_config
    icon: mdi:upload
    entity_category: config
    on_press:
      then:
        - logger.log: "üì§ –ó–∞–ø–∏—Å—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ —Ä–∞–¥–∞—Ä..."
        - lambda: |-
            ESP_LOGI("LD2450", "–ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:");
            ESP_LOGI("LD2450", "  –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: %d", id(radar_sensitivity));
            ESP_LOGI("LD2450", "  –ü–æ—Ä–æ–≥ —ç–Ω–µ—Ä–≥–∏–∏: %d", id(energy_threshold));
            ESP_LOGI("LD2450", "  Timeout —É–¥–µ—Ä–∂–∞–Ω–∏—è: %d —Å–µ–∫", id(target_hold_time));
            ESP_LOGI("LD2450", "  –§–∏–ª—å—Ç—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏: %d —Å–º/—Å", id(speed_filter));
            ESP_LOGI("LD2450", "  –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: %d", id(working_mode));
            ESP_LOGI("LD2450", "  –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: %d –ì—Ü", id(update_rate));
            
            uint8_t sens = (uint8_t)id(radar_sensitivity);
            uint8_t cmd_sensitivity[] = {
              0xFD, 0xFC, 0xFB, 0xFA,
              0x0A, 0x00,
              0x64, 0x00,
              sens, sens, sens, sens, sens, sens, sens, sens,
              0x04, 0x03, 0x02, 0x01
            };
            id(uart_bus).write_array(cmd_sensitivity, sizeof(cmd_sensitivity));
            delay(50);
            
            uint16_t energy = (uint16_t)id(energy_threshold);
            uint8_t cmd_energy[] = {
              0xFD, 0xFC, 0xFB, 0xFA,
              0x04, 0x00,
              0x60, 0x00,
              (uint8_t)(energy & 0xFF),
              (uint8_t)((energy >> 8) & 0xFF),
              0x04, 0x03, 0x02, 0x01
            };
            id(uart_bus).write_array(cmd_energy, sizeof(cmd_energy));
            delay(50);
            
            uint16_t hold_time = (uint16_t)id(target_hold_time);
            uint8_t cmd_hold[] = {
              0xFD, 0xFC, 0xFB, 0xFA,
              0x04, 0x00,
              0x61, 0x00,
              (uint8_t)(hold_time & 0xFF),
              (uint8_t)((hold_time >> 8) & 0xFF),
              0x04, 0x03, 0x02, 0x01
            };
            id(uart_bus).write_array(cmd_hold, sizeof(cmd_hold));
            delay(50);
            
            uint8_t speed = (uint8_t)id(speed_filter);
            uint8_t cmd_speed[] = {
              0xFD, 0xFC, 0xFB, 0xFA,
              0x03, 0x00,
              0x62, 0x00,
              speed,
              0x04, 0x03, 0x02, 0x01
            };
            id(uart_bus).write_array(cmd_speed, sizeof(cmd_speed));
            delay(50);
            
            uint8_t mode = (uint8_t)id(working_mode);
            uint8_t cmd_mode[] = {
              0xFD, 0xFC, 0xFB, 0xFA,
              0x03, 0x00,
              0x65, 0x00,
              mode,
              0x04, 0x03, 0x02, 0x01
            };
            id(uart_bus).write_array(cmd_mode, sizeof(cmd_mode));
            delay(50);
            
            uint8_t rate = (uint8_t)id(update_rate);
            uint8_t cmd_rate[] = {
              0xFD, 0xFC, 0xFB, 0xFA,
              0x03, 0x00,
              0x66, 0x00,
              rate,
              0x04, 0x03, 0x02, 0x01
            };
            id(uart_bus).write_array(cmd_rate, sizeof(cmd_rate));
            delay(50);
            
            uint8_t cmd_save[] = {
              0xFD, 0xFC, 0xFB, 0xFA,
              0x02, 0x00,
              0x60, 0x61,
              0x04, 0x03, 0x02, 0x01
            };
            id(uart_bus).write_array(cmd_save, sizeof(cmd_save));
            
            ESP_LOGI("LD2450", "‚úÖ –ö–æ–º–∞–Ω–¥—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–∞–¥–∞—Ä");
            ESP_LOGI("LD2450", "‚ö†Ô∏è –í–ê–ñ–ù–û: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ä–∞–¥–∞—Ä –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è!");
        - logger.log: "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ —Ä–∞–¥–∞—Ä"
  
  - platform: template
    name: "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–¥–∞—Ä"
    icon: mdi:restart-alert
    entity_category: config
    on_press:
      then:
        - logger.log: "üîÑ –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–¥–∞—Ä..."
        - button.press: btn_write_config
        - delay: 1s
        - button.press: radar_radar_restart
        - delay: 3s
        - logger.log: "‚úÖ –†–∞–¥–∞—Ä –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
